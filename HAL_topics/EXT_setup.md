# Работа с внешними прерываниями на STM-ке c ChibiOS/HAL

## Первый шаг - выбор пина

Стандартная процедура по включению модуля внешних прерываний (EXT/PAL_EVENTS) и выявлению незадействованных пинов микроконтроллера (МК). 

> Предположим, что мы хотим генерировать прерывание при нажатии на кнопку, установленную на плате - синяя такая. Она подключена к пину PC13.  

Для работы с внешними прерываниями доступны все пины I/O, любой из них можно указать в одном из 16-ти каналов модуля внешних прерываний. 

## Второй шаг - настройка модуля PAL_EVENTS

Первым делом надо установить переменную `PAL_USE_CALLBACKS` в файле `halconf.h` в значение `TRUE`, чтобы контроллер мог вызывать обработчик событий при появлении на пине.

Далее, пишем обработчик прерывания для обработки события на ножке:

```cpp
static void extcb( void *arg )
{
  palToggleLine( LINE_LED1 ); 
}
```

Обработчик простой - будем мигать светодиодом. Что же дальше? Правильно, подключаем обработчик к ножке и настраиваем тип события в `main()`:

```cpp
palSetPadCallback( GPIOC, 13, extcb, NULL );
palEnablePadEvent( GPIOC, 13, PAL_EVENT_MODE_BOTH_EDGES );
```

Первые два аргумента достаточно понятные, с ними уже работали на уровне драйвера PAL для мигания диодом.
Функция `palSetPadCallback()`:
- port - установка порта интересующего пина
- pad - установка номера интересующего пина
- callback - функция-обработчик, которая будет вызвана, когда произойдет событие на пине
- arg - указатель, который бует передан в обработчик прерывания одноименным аргументом

Функция `palEnablePadEvent()`:
- port - установка порта интересующего пина
- pad - установка номера интересующего пина
- event - тип события, может быть:
  * `PAL_EVENT_MODE_DISABLED` - отключен;
  * `PAL_EVENT_MODE_RISING_EDGE` - фронт сигнала;
  * `PAL_EVENT_MODE_FALLING_EDGE` - срез сигнала;
  * `PAL_EVENT_MODE_BOTH_EDGES` - реакция на срез и на фронт;
